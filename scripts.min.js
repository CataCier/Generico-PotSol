FIUBAMAP = null;

class FiubaMap {
    constructor(data, carrera) {
        FIUBAMAP = this
        this.init(data);
        this.carrera = carrera;
        this.creditos = 0;
        this.cuatri = cuatriActual()
        setCuatri(this.cuatri)
        this.aprobadas = new Map();
        resetBindings(this)
        this.actualizarCreditos();
        this.actualizarPromedio();
    }

    aprobar(id, nota, cuatri, cambioCuatri) {
        this.desaprobar(id, cambioCuatri)
        let mat = this.materias.get(id)
        mat.aprobar(nota)
        this.agregarMateria(mat, cuatri)
        this.actualizar()
    }

    desaprobar(id, cambioCuatri) {
        let mat = this.materias.get(id)
        if (!cambioCuatri)
            this.removerMateria(mat)
        mat.desaprobar()
        this.actualizar()
    }

    cambiarCuatri() {
        const self = this
        self.aprobadas.forEach((map,cuatri) => {
            cuatri = parseFloat(cuatri)
            if (cuatri > self.cuatri) {
                map.forEach((v,k) => {
                    if (self.materias.get(k).nota == -1 && v != -1) return
                    self.desaprobar(k, true)
                })
            }
            else {
                map.forEach((v,k) => {
                    self.aprobar(k, v, cuatri, true)
                })
            }
        })
        this.actualizar()
        this.chequearNodosCRED()
    }

    actualizar() {
        this.actualizarPromedio();
        this.actualizarCreditos();
    }

    actualizarPromedio() {
        const self = this
        let sumatoria = 0
        let cantidad = 0
        let materias = materiasAprobadasConNota(self.aprobadas, self.cuatri)
        materias.forEach((nota, materia) => {
            sumatoria += nota
            cantidad++
        })
        let promedio = (sumatoria / cantidad).toFixed(2);
        if (!isNaN(promedio))  {
            $('#promedio').text("Promedio: "+promedio);
            $("#promedio").show();
        }
        else $('#promedio').empty();
    }

    actualizarCreditos() {
        const self = this
        let cred = 0
        let materias = materiasAprobadas(self.aprobadas, self.cuatri)
        materias.forEach((id) => {
            let m = this.materias.get(id)
            cred+=m.creditos
        })

        $('#creditos-var').text(cred)
        self.creditos = cred
    }

    chequearNodosCRED() {
        this.materias_cred.forEach(nodo => {
            if (this.creditos < nodo.requiere) nodo.deshabilitar();
            else if (this.creditos >= nodo.requiere) nodo.habilitar();
        })
    };

    agregarMateria(mat, cuatri) {
        let aprobadasEnCuatri = this.aprobadas.get(cuatri)
        if (!aprobadasEnCuatri)
            aprobadasEnCuatri = new Map()
        aprobadasEnCuatri.set(mat.id, mat.nota)
        this.aprobadas.set(parseFloat(cuatri), aprobadasEnCuatri)
    }

    removerMateria(mat) {
        this.aprobadas.forEach((map, cuatri) => {
            map.delete(mat.id)
            if (!map.size)
                this.aprobadas.delete(cuatri)
        })
    }

    init(data) {
        let nodos = [];
        let materias = new Map();
        let aristas = [];
        let grupos = [];
        let materiasCred = [];
        let filas = data.split(/\r?\n|\r/);
        for (let fila = 1; fila < filas.length; fila++) {
            if (!filas[fila]) continue;
            let [codigo, titulo, creditos, correlativas, categoria, nivel] = filas[fila].split(',');;
            let materia = new Materia(codigo, titulo, creditos, categoria, nivel);
            correlativas.split('-').forEach(c => {
                if (c.includes('CRED')) {
                    // Una materia CRED requiere n creditos para aprobar (ej: legislatura necesita 140 creditos)
                    let [, n] = c.split('CRED');
                    materia.requiere = n;
                    materiasCred.push(materia)
                }
                let arista = {from: c, to: materia.id};
                // Las aristas entre CBC y los nodos CRED sirven para que el layout quede bien
                // Pero no deben ser mostradas
                if (c == 'CBC' && materia.requiere) arista.hidden = true;
                aristas.push(arista)
            });
            materia.setTitle();
            nodos.push(materia);
            materias.set(codigo, materia);
            if (!grupos.includes(materia.categoria)) grupos.push(materia.categoria);
        }
        this.materias = materias
        this.materias_cred = materiasCred
        this.nodos = new vis.DataSet(nodos)
        this.network = crearNetwork(this.nodos, new vis.DataSet(aristas));

        let electivas = {
            joinCondition: function (nodeOptions) {
                return nodeOptions.categoria === 'Materias Electivas';
            },
            clusterNodeProperties: {id: 'cluster-Materias Electivas', hidden: true, level: 20, allowSingleNodeCluster: true}
        }
        let htmlelectivas = `<a class='toggle' id='toggle-Materias Electivas'>Electivas</a>`
        this.network.cluster(electivas);

        grupos = grupos.filter(g => g.includes('Orientación'))
        if (grupos.length == 0) {
            $("#materias").append(htmlelectivas)
        }
        else {
            let html = `
            <a class="dropbtn">
                <span>Materias</span>
                <i class="fas fa-fw fa-caret-down"></i>
            </a>
            <div id='materias-dropdown' class="dropdown-content dropdown-content-right">`+htmlelectivas+`</div>`
            $("#materias").append(html)
            grupos.forEach(g => {
                let cluster = {
                    joinCondition: function (nodeOptions) {
                        return nodeOptions.categoria === g;
                    },
                    clusterNodeProperties: {id: 'cluster-' + g, hidden: true, level: 20, allowSingleNodeCluster: true}
                }
                this.network.cluster(cluster);
                let [, categoria] = g.split(':');
                $("#materias-dropdown").append("<a class='toggle' id='toggle-" + g + "'>" + categoria + "</a>");
            })
        }
    }
}
class Materia {
    constructor(codigo, titulo, creditos, categoria, nivel) {
        this.id = codigo;
        this.label = breakWords(titulo);
        this.creditos = parseInt(creditos);
        this.group = categoria;
        this.level = nivel;
        this.categoria = categoria;
        this.aprobada = false;
        this.nota = 0;
        this.habilitada = false;
    }

    aprobar(nota){
        this.aprobada = true;
        this.nota = parseInt(nota)
        if (this.label.includes('['))
            this.label = this.label.split('\n[')[0];
        if (nota == -1) {
            this.label += '\n[Final]';
            this.actualizar();
            return
        }
        if (nota > 0) this.label += '\n[' + this.nota + ']';
        let materiasQueYoHabilito = FIUBAMAP.network.getConnectedNodes(this.id, 'to');
        materiasQueYoHabilito.forEach(m => {
            let x = FIUBAMAP.materias.get(m);
            if (x) x.habilitar()
        })
        this.actualizar();
    }

    habilitar() {
        let materiasQueMeHabilitan = FIUBAMAP.network.getConnectedNodes(this.id, 'from');
        let todoAprobado = true;
        for (let i = 0; i < materiasQueMeHabilitan.length; i++) {
            let correlativa = FIUBAMAP.materias.get(materiasQueMeHabilitan[i]);
            if (!correlativa) continue;
            todoAprobado &= correlativa.aprobada
        }
        if (!todoAprobado || FIUBAMAP.creditos < this.requiere) return;
        this.habilitada = true;
        this.actualizar()
    }

    desaprobar() {
        this.aprobada = false;
        this.nota = 0;
        if (this.label.includes('['))
            this.label = this.label.split('\n[')[0];
        let materiasQueHabilita = FIUBAMAP.network.getConnectedNodes(this.id, 'to');
        materiasQueHabilita.forEach(m => {
            let x = FIUBAMAP.materias.get(m);
            if (x) x.deshabilitar()
        });
        this.actualizar()
    }

    deshabilitar() {
        this.habilitada = false;
        this.actualizar()
    }

    actualizar() {
        let grupoDefault = this.categoria;
        if (this.aprobada && this.nota >=0) grupoDefault = 'Aprobadas';
        else if (this.aprobada) grupoDefault = 'En Final';
        else if (this.habilitada) grupoDefault = 'Habilitadas';
        this.group = grupoDefault;
        FIUBAMAP.nodos.update(this)
        FIUBAMAP.actualizar()
    }

    setTitle() {
        this.title = "Otorga: "+this.creditos+ " créditos";
        if (this.requiere) {
            this.title += " -- Requiere: "+this.requiere + " créditos";
        }
    }

    mostrarOpciones() {
        const self = this;
        let nota = self.nota ? self.nota : '';
        let html = `
        <div id="materia" class="center">
            <p id="materia-close" class="close-button" onclick="defaultFooterSnackbar();"><i class="fas fa-fw fa-times"></i></p> 
            <small><p><strong>[`+self.id+`] </strong>`+self.label.split('(')[0]+`</p></small>
            <div>
                <input type="number" min="4" max="10" placeholder="Nota" value="` + nota + `" />
                <button id='materia-aprobar' style="background-color: `+FIUBAMAP.network.groups.groups['Aprobadas'].color+`">Aprobar</button>
            </div>
            <div><button id='materia-enfinal' style="background-color:`+FIUBAMAP.network.groups.groups['En Final'].color+`">Poner En Final</button></div>
        </div>
        `;
        $('#footer-snackbar-left').html($(html));
    
        $('#materia-aprobar').on('click', function () {
            let nota = $('#materia input').val();
            if (nota < 4 || nota > 10) return;
            if (!nota) nota = 0;
            FIUBAMAP.aprobar(self.id, nota, FIUBAMAP.cuatri);
            $("#materia-close").click()
        });
    
        $('#materia-enfinal').on('click', function () {
            FIUBAMAP.aprobar(self.id, -1, FIUBAMAP.cuatri);
            $("#materia-close").click()
        });
    
        $('#materia').on("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                $("#materia-aprobar").click()
            }
        });
    }
}
function resetBindings(FMap) {
    const self = FMap;
    $('.toggle').off('click').on('click', function () {
        let [, id] = $(this).attr('id').split('-');
        if (self.network.isCluster('cluster-' + id)) {
            self.network.openCluster('cluster-' + id);
            let color = self.network.groups.groups[id].color
            $(this).css("background-color", color);
        }
        else {
            self.network.cluster({
                joinCondition: function (nodeOptions) { return nodeOptions.categoria === id; },
                clusterNodeProperties: {id: 'cluster-' + id, hidden: true, level: 20, allowSingleNodeCluster: true}
            })
            $(this).css("background-color", "");
        }
        self.network.fit()
    });

    self.network.off('click').on("click", function (params) {
        if (!params.event.isFinal) return;
        let id = params.nodes[0];
        if (!id) {
            $(".close-button").click();
            return;
        }
        if (!self.materias.get(id).aprobada || self.materias.get(id).nota == -1) {
            self.aprobar(id, 0, self.cuatri)
            $(".close-button").click();
            self.materias.get(id).mostrarOpciones()
        } else {
            self.desaprobar(id)
            $(".close-button").click();
        }
        self.chequearNodosCRED()
    });
}

function breakWords(string) {
    let broken = '';
    string.split(' ').forEach(element => {
        if (element.length < 5) broken += ' ' + element;
        else broken += '\n' + element;
    });
    return broken.trim();
}

function materiasAprobadasConNota(aprobadasTotal, cuatriActual) {
    let aprobadas = new Map()
    let maxCuatri = -1
    aprobadasTotal.forEach((map, cuatri) => {
        if (cuatri > cuatriActual) return
        map.forEach((nota, materia) => {
            if (nota <= 0) return;
            if (aprobadas.has(materia)) {
                if (cuatri > maxCuatri) {
                    aprobadas.set(materia, nota)
                    maxCuatri = cuatri
                }
            }
            else
                aprobadas.set(materia, nota)
        })
    })
    return aprobadas
}

function materiasAprobadas(aprobadasTotal, cuatriActual) {
    let aprobadas = []
    aprobadasTotal.forEach((map, cuatri) => {
        if (cuatri > cuatriActual) return
        map.forEach((nota, materia) => {
            if (nota == -1) return;
            if (aprobadas.includes(materia)) return;
            aprobadas.push(materia)
        })
    })
    return aprobadas
}

function crearNetwork(nodes, edges) {
    let data = {nodes: nodes, edges: edges};
    let options = {
        nodes: {shape: 'box'},
        layout: {hierarchical: {enabled: true, direction: 'LR', levelSeparation: 150}},
        edges: {arrows: {to: {enabled: true, scaleFactor: 0.7, type: 'arrow'}}},
        groups: {
            'Aprobadas': {color: '#1dd1a1'},
            'CBC': {color: '#ff9f43'},
            'Habilitadas': {color: '#ff9f43'},
            'En Final': {color: '#feca57'},
            'Materias Obligatorias': {color: '#54a0ff'},
            'Materias Electivas': {color: '#a29bfe'},
            // Informática
            'Orientación: Gestión Industrial de Sistemas': {color: '#fab1a0'},
            'Orientación: Sistemas Distribuidos': {color: '#C4E538'},
            'Orientación: Sistemas de Producción': {color: '#fd79a8'},
            // Mecánica
            'Orientación: Diseño Mecánico': {color: '#fab1a0'},
            'Orientación: Termomecánica': {color: '#C4E538'},
            'Orientación: Metalúrgica': {color: '#fd79a8'},
            'Orientación: Computación Aplicada': {color: '#BDC581'},
            'Orientación: Industrias': {color: '#EE5A24'},
            // Electrónica
            'Orientación: Multiples Orientaciones': {color: '#fab1a0'},
            'Orientación: Procesamiento de Señales': {color: '#C4E538'},
            'Orientación: Automatización y Control': {color: '#fd79a8'},
            'Orientación: Física Electrónica': {color: '#BDC581'},
            'Orientación: Telecomunicaciones': {color: '#EE5A24'},
            'Orientación: Sistemas Digitales y Computación': {color: '#FFE4E1'},
            'Orientación: Multimedia': {color: '#FFDAB9'},
            'Orientación: Instrumentación Biomédica': {color: '#66CDAA'},
        },
    };

    return new vis.Network($('#grafo')[0], data, options);
}

function notificationSnackbar(clave) {
    let html = `
        <div id="notification">
            <p class="close-button" onclick="$(this.parentElement.parentElement).empty();"><i class="fas fa-fw fa-times"></i></p> 
            <p><strong>Datos guardados!</strong> Ya podés entrar a <a href=https://catacier.github.io/Generico-PotSol/?clave=` + clave + `>https://catacier.github.io/Generico-PotSol/?clave=` + clave + `</a> y ver tu progreso.</p>
        </div>
    `;
    $('#footer-snackbar-center').html($(html));    
}

function warningSnackbar(clave){
    let html = `
        <div id="alert">
            <p class="close-button" onclick="$(this.parentElement.parentElement).empty();"><i class="fas fa-fw fa-times"></i></p> 
            <p><strong>Padrón no registrado!</strong> Seleccioná tu carrera, marca las materias que aprobaste y toca el boton de guardar.
            <br>
            Una vez guardado, podés entrar a <a href=https://catacier.github.io/Generico-PotSol/?clave=` + clave + `>https://catacier.github.io/Generico-PotSol/?clave=` + clave + `</a> y ver tu progreso.</p>
        </div>
    `;
    $('#footer-snackbar-center').html($(html));
}

function defaultFooterSnackbar() {
    let html = `
    <div>
        <a target="_blank" href="https://github.com/fdelmazo/FIUBA-Map"><i class="fab fa-fw fa-github"></i></a> 
        <a><i onclick="$('#mail-content').toggle()" class="fas fa-fw fa-envelope"></i><span id="mail-content"> fdelmazo at fi.uba.ar</span></a> 
    </div>
    `;
    $('#footer-snackbar-left').html($(html));
}function setCuatri(cuatri) {
    FIUBAMAP.cuatri = cuatri
    $("#cuatri input").val(cuatri.toString().replace('.','c').replace(',','c'))
}

function getCuatri() {
    return parseFloat($("#cuatri input").val().replace('c','.'))
}

function cuatriActual() {
    date = new Date()
    anio = date.getYear() + 1900
    mes = date.getMonth()
    if (mes <= 6) cuatri = 1
    else cuatri = 2
    return parseFloat(anio+'.'+cuatri)
}

function getPrev(cuatri) {
    let dec = (cuatri - Math.floor(cuatri)).toFixed(1)*10
    if (dec == 1)
        return parseFloat((cuatri - 0.9).toFixed(1))
    else
        return parseFloat((cuatri - 0.1).toFixed(1))
}

function getNext(cuatri) {
    let dec = (cuatri - Math.floor(cuatri)).toFixed(1)*10
    if (dec == 1) {
        return parseFloat((cuatri + 0.1).toFixed(1))
    }
    else
        return parseFloat((cuatri + 0.9).toFixed(1))
}

$(document).ready(function () {
    $(document).on("keyup", function (event) {
        if (event.keyCode === 37) {
            setCuatri(getPrev(getCuatri()))
            FIUBAMAP.cambiarCuatri()
        }
        if (event.keyCode == 39) {
            setCuatri(getNext(getCuatri()))
            FIUBAMAP.cambiarCuatri()
        }
    })
    $("#cuatri-next").on("click", function (event) {
        setCuatri(getNext(getCuatri()))
        FIUBAMAP.cambiarCuatri()
    })
    $("#cuatri-prev").on("click", function (event) {
        setCuatri(getPrev(getCuatri()))
        FIUBAMAP.cambiarCuatri()
    })
})
let FORMAPI = 'https://docs.google.com/forms/d/18EzhRKs4nyOVGgoVHsH35RsbT9BCRmftAhMe-8NtE94';
let SHEETAPI = "https://spreadsheets.google.com/feeds/list/1Xng29KS8L5hG972OSEdMu0JG8STqAl4-zMk6RCMhaIo/default/public/values?alt=json";


function save(clave, carrera, materias) {
    let form = $("<form id='formRecord' type='hidden' action=" + FORMAPI + " onsubmit='return window.submitGoogleForm(this)'></form>");
    form.append("<input name='entry.774465991' value=" + clave + ">");
    form.append("<input name='entry.992084860' value=" + carrera + ">");
    form.append("<input name='entry.2026137499' value=" + materias + ">");
    form.submit()
}

function loadMap(api, clave) {
    $("#clave input").val(clave);
    let data = api.feed.entry;
    let usuario = null;
    data.forEach(fila => {
        if (fila.gsx$clave.$t == clave) usuario = fila
    });
    if (!usuario) {
        warningSnackbar(clave);
        $("#sistemas").click()
        return
    }
    let carrera = usuario.gsx$carrera.$t;
    let materias = usuario.gsx$materias.$t;
    let materiasAprobadas = materias
    main(carrera)
    cargarMaterias(materiasAprobadas)
}

$(document).ready(function () {
    $('#clave-save').on('click', function () {
        let clave = $("#clave input").val();
        if (!clave) return;
        let carrera = FIUBAMAP.carrera;
        let materias = mapToJson(FIUBAMAP.aprobadas)
        save(clave, carrera, materias);
        let url = new URL(window.location.href);
        url.searchParams.set('clave', clave)    
        window.history.pushState("", "", url.toString())
        notificationSnackbar(clave)
    });

    $('#clave-load').on('click', function () {
        let clave = $("#clave input").val();
        if (!clave) return;
        window.location = "https://catacier.github.io/Generico-PotSol?clave=" + clave;
    });

    $('#clave input').on("keyup", function (event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            $("#clave-load").click();
        }
    });
});

function cargarMaterias(materias) {
    let map = objToMap(materias)
    FIUBAMAP.aprobadas = map
    FIUBAMAP.cambiarCuatri()
}

function mapToJson(map){
    let obj = {}
    map.forEach((map,cuatri) => {
        obj[cuatri] = Object.fromEntries(map)
    })
    return JSON.stringify(obj)        
}

function objToMap(obj){
    let json = JSON.parse(obj)
    let map = new Map()
    Object.keys(json).forEach(cuatri => {
        let submap = new Map()
        Object.keys(json[cuatri]).forEach(id => {
            submap.set(id, parseInt(json[cuatri][id]))
        })
        map.set(parseFloat(cuatri), submap)
    })
    return map
}
!function (exports) {
    exports.submitGoogleForm = submitGoogleForm;

    function submitGoogleForm(form) {
        try {
            const data = [].slice.call(form).map(function (control) {
                return 'value' in control && control.name ?
                    control.name + '=' + (control.value === undefined ? '' : control.value) :
                    '';
            }).join('&');
            const xhr = new XMLHttpRequest();

            xhr.open('POST', form.action + '/formResponse', true);
            xhr.setRequestHeader('Accept',
                'application/xml, text/xml, */*; q=0.01');
            xhr.setRequestHeader('Content-type',
                'application/x-www-form-urlencoded; charset=UTF-8');
            xhr.send(data);
        } catch (e) {
        }

        form.parentNode.className += ' submitted';

        return false;
    }
}(typeof module === 'undefined' ? window : module.exports);
function main(carrera) {
    $("#grafo").html("<div class='loader'></div>");
    defaultFooterSnackbar()
    $('#carreras .dropdown-content').hide();
    $("#carreras .active").removeClass('active');
    $("#materias").empty();
    let filename, titulo, tituloShort, plan;
    switch (carrera) {
        case 'fondeo1':
            filename = 'data/fondeo1.csv';
            plan = 'Demo';
            titulo = 'Fondeo 1';
            tituloShort = 'fondeo1';
            break;
        case 'fondeo2':
            filename = 'data/fondeo2.csv';
            plan = 'Demo';
            titulo = 'Fondeo 2';
            tituloShort = 'fondeo2';
            break;
    }

    $("#carrera-actual-long").text(titulo + ' | ' + plan);
    $("#carrera-actual-short").text(tituloShort);
    $("#" + carrera).addClass('active');

    $.ajax({
        url: filename,
        dataType: 'text',
        success: function (data) {
            new FiubaMap(data, carrera)
        },
        async: false
    })
}

$(document).ready(function () {
    $(".dropdown").on("mouseover", function () {
        $(this).children('.dropdown-content').show()
    });

    $(".dropdown").on("mouseout", function () {
        $(this).children('.dropdown-content').hide()
    });

    $('.carrera').on('click', function () {
        main($(this).attr('id'))
        FIUBAMAP.aprobar("CBC", 0, FIUBAMAP.cuatri)
    });

    $(document).keydown(function (event) {
        if (event.keyCode == 27)
            $('.close-button').click();
    });
});

$(document).ready(function () {
    $("#grafo").html("<div class='loader'></div>");
    defaultFooterSnackbar()
    let url = new URL(window.location.href);
    let clave = url.searchParams.get('clave')
    if (clave)
        $.ajax({
            url: SHEETAPI,
            method: 'GET',
            success: function (data) {
                loadMap(data, clave)
            }
        })
    else
        $("#fondeo1").click()
});
$(document).ready(function () {
    $("#fullscreen-mode").on("click", function () {
        $("#header").remove()
        $("#footer").remove()
    })
    $("#dark-mode").on("click", function () {
        if ($('html').hasClass('dark')) {
            $('html').removeClass('dark')
            $("#dark-mode i").removeClass('fa-sun')
            $("#dark-mode i").addClass('fa-moon')
        }
        else {
            $('html').addClass('dark')
            $("#dark-mode i").removeClass('fa-moon')
            $("#dark-mode i").addClass('fa-sun')
        }
    })
})
